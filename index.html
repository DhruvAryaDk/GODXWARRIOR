<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peer-to-Peer Video Call + Global Chat (Gun.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #121212;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      color: #00e676;
      text-align: center;
      user-select: none;
    }
    #videos {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 900px;
    }
    video {
      background: #000;
      border-radius: 12px;
      width: 45vw;
      max-width: 420px;
      aspect-ratio: 16/9;
      box-shadow: 0 0 12px #00e676aa;
    }
    #controls {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 1rem;
    }
    input[type=text], input[type=password] {
      background: #222;
      border: none;
      border-radius: 8px;
      padding: 12px;
      color: #e0e0e0;
      font-size: 1rem;
      width: 100%;
      transition: box-shadow 0.3s ease;
    }
    input[type=text]:focus, input[type=password]:focus {
      outline: none;
      box-shadow: 0 0 6px #00e676;
    }
    button {
      background: #00e676;
      border: none;
      border-radius: 8px;
      padding: 12px;
      color: #121212;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background: #00c853;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #status {
      min-height: 1.5em;
      font-size: 0.9rem;
      font-style: italic;
      color: #888;
      text-align: center;
      user-select: none;
      margin-bottom: 1rem;
    }
    #callControls {
      display: none;
      justify-content: center;
      gap: 1rem;
      margin-top: 10px;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    #callControls button {
      width: 110px;
    }
    @media(max-width: 600px) {
      video {
        width: 90vw;
      }
      #callControls button {
        width: 45vw;
      }
    }

    /* Chat styles */
    #chatContainer {
      width: 100%;
      max-width: 900px;
      background: #222;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      height: 300px;
      user-select: none;
    }
    #chatMessages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 12px;
      font-size: 0.9rem;
      color: #eee;
      border-bottom: 1px solid #444;
    }
    #chatInputContainer {
      display: flex;
      padding: 10px;
      gap: 10px;
    }
    #chatInput {
      flex-grow: 1;
      background: #333;
      border: none;
      border-radius: 8px;
      padding: 10px;
      color: #eee;
      font-size: 1rem;
    }
    #chatInput:focus {
      outline: none;
      box-shadow: 0 0 6px #00e676;
    }
    #chatSendBtn {
      background: #00e676;
      border: none;
      border-radius: 8px;
      color: #121212;
      font-weight: 700;
      cursor: pointer;
      padding: 10px 16px;
      transition: background 0.3s ease;
      user-select: none;
    }
    #chatSendBtn:hover {
      background: #00c853;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer Video Call + Global Chat</h1>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="controls">
    <input id="roomName" type="text" placeholder="Room Name (letters & numbers only)" pattern="[a-zA-Z0-9]+" required autocomplete="off" />
    <input id="password" type="password" placeholder="Room Password" required autocomplete="off" />
    <button id="createRoomBtn">Create Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="callControls">
    <button id="toggleAudioBtn">Mute Mic</button>
    <button id="toggleVideoBtn">Stop Video</button>
    <button id="hangupBtn" style="background:#e53935;color:#fff;">Hang Up</button>
  </div>

  <p id="status"></p>

  <!-- Global Chat Section -->
  <div id="chatContainer">
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" placeholder="Type message here..." autocomplete="off" />
      <button id="chatSendBtn">Send</button>
    </div>
  </div>

  <script>
    // Gun setup
    const gun = Gun();

    // RTC config
    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    let localStream, pc, roomRef;
    let audioEnabled = true;
    let videoEnabled = true;

    // UI elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const roomNameInput = document.getElementById('roomName');
    const passwordInput = document.getElementById('password');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const statusEl = document.getElementById('status');
    const callControls = document.getElementById('callControls');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const hangupBtn = document.getElementById('hangupBtn');

    // Chat UI
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');

    // Global chat Gun node
    const globalChatRef = gun.get('globalChat');

    // Append message to chat box
    function appendChatMessage(from, message, system = false) {
      const el = document.createElement('div');
      el.style.marginBottom = '6px';
      el.style.wordBreak = 'break-word';
      if(system) {
        el.style.color = '#888';
        el.style.fontStyle = 'italic';
        el.textContent = `[System] ${message}`;
      } else {
        el.innerHTML = `<b>${from}:</b> ${message}`;
      }
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Listen for incoming global chat messages
    globalChatRef.map().on(data => {
      if(!data || !data.from || !data.message) return;
      appendChatMessage(data.from, data.message, data.system);
    });

    // Send chat message
    function sendChatMessage(message, system = false) {
      if(!message.trim()) return;
      const from = roomNameInput.value.trim() || 'Anon';
      globalChatRef.set({
        from,
        message,
        system: system || false,
        timestamp: Date.now()
      });
    }

    chatSendBtn.onclick = () => {
      const msg = chatInput.value.trim();
      if(msg) {
        sendChatMessage(msg);
        chatInput.value = '';
      }
    };

    chatInput.addEventListener('keydown', e => {
      if(e.key === 'Enter') {
        e.preventDefault();
        chatSendBtn.click();
      }
    });

    // Log status message on page
    function logStatus(msg) {
      statusEl.textContent = msg;
      console.log(msg);
    }

    async function startLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        logStatus('Camera and mic started.');
      } catch (err) {
        alert('Error accessing media devices: ' + err.message);
        logStatus('Error accessing camera or mic.');
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(configuration);

      // Send ICE candidates to Gun and global chat
      pc.onicecandidate = event => {
        if (event.candidate) {
          roomRef.get('iceCandidates').set({ candidate: event.candidate.toJSON() });
          logStatus('Sent ICE candidate.');
          sendChatMessage(`Sent ICE candidate`, true);
        }
      };

      // When remote track received
      pc.ontrack = event => {
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          logStatus('Remote stream received.');
          sendChatMessage(`Remote stream received`, true);
        }
      };

      // Add all local tracks
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    async function createRoom() {
      const room = roomNameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!room || !pass) {
        alert('Please enter room name and password.');
        return;
      }
      if (!/^[a-zA-Z0-9]+$/.test(room)) {
        alert('Room name must be letters and numbers only.');
        return;
      }

      logStatus('Creating room...');
      createRoomBtn.disabled = true;
      joinRoomBtn.disabled = true;
      roomRef = gun.get(room + '_' + pass);

      await startLocalStream();
      createPeerConnection();

      // Clear old room data (best effort)
      roomRef.put({});

      // Create offer and send to Gun and global chat
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      roomRef.put({ offer: offer.toJSON() });

      logStatus('Offer created and sent. Waiting for answer...');
      sendChatMessage(`Room "${room}" created with offer sent. Waiting for answer...`, true);

      // Listen for answer from joiner
      roomRef.get('answer').on(async (answer) => {
        if (!answer) return;
        logStatus('Answer received! Setting remote description...');
        sendChatMessage(`Answer received from joiner.`, true);
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
        callControls.style.display = 'flex';
      });

      // Listen for remote ICE candidates
      roomRef.get('iceCandidates').map().on(async (data) => {
        if (!data || !data.candidate) return;
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          logStatus('Added ICE candidate from remote.');
          sendChatMessage(`Added ICE candidate from remote`, true);
        } catch (e) {
          console.warn('Failed to add ICE candidate:', e);
        }
      });
    }

    async function joinRoom() {
      const room = roomNameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!room || !pass) {
        alert('Please enter room name and password.');
        return;
      }
      if (!/^[a-zA-Z0-9]+$/.test(room)) {
        alert('Room name must be letters and numbers only.');
        return;
      }

      logStatus('Joining room...');
      createRoomBtn.disabled = true;
      joinRoomBtn.disabled = true;
      roomRef = gun.get(room + '_' + pass);

      await startLocalStream();
      createPeerConnection();

      // Wait for offer from creator
      roomRef.get('offer').once(async (offer) => {
        if (!offer) {
          alert('No offer found. Check room name and password.');
          resetButtons();
          return;
        }
        logStatus('Offer found, setting remote description...');
        sendChatMessage(`Offer found from creator.`, true);
        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        // Create answer and send to Gun and global chat
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        roomRef.put({ answer: answer.toJSON() });

        logStatus('Answer sent! Waiting for ICE candidates...');
        sendChatMessage(`Answer sent to creator.`, true);
        callControls.style.display = 'flex';

        // Listen for ICE candidates from creator
        roomRef.get('iceCandidates').map().on(async (data) => {
          if (!data || !data.candidate) return;
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            logStatus('Added ICE candidate from remote.');
            sendChatMessage(`Added ICE candidate from remote`, true);
          } catch (e) {
            console.warn('Failed to add ICE candidate:', e);
          }
        });
      });
    }

    function toggleAudio() {
      if (!localStream) return;
      audioEnabled = !audioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
      toggleAudioBtn.textContent = audioEnabled ? 'Mute Mic' : 'Unmute Mic';
      sendChatMessage(`Microphone ${audioEnabled ? 'unmuted' : 'muted'}`, true);
    }

    function toggleVideo() {
      if (!localStream) return;
      videoEnabled = !videoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = videoEnabled);
      toggleVideoBtn.textContent = videoEnabled ? 'Stop Video' : 'Start Video';
      sendChatMessage(`Camera ${videoEnabled ? 'started' : 'stopped'}`, true);
    }

    function hangUp() {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      logStatus('Call ended.');
      sendChatMessage(`Call ended.`, true);

      resetButtons();
      callControls.style.display = 'none';
    }

    function resetButtons() {
      createRoomBtn.disabled = false;
      joinRoomBtn.disabled = false;
    }

    // Attach event handlers
    createRoomBtn.onclick = createRoom;
    joinRoomBtn.onclick = joinRoom;
    toggleAudioBtn.onclick = toggleAudio;
    toggleVideoBtn.onclick = toggleVideo;
    hangupBtn.onclick = hangUp;
  </script>
</body>
</html>
