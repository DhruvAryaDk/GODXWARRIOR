<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-Time Global Chat App</title>
  <!-- GunDB Core and SEA Module -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #1a202c;
      font-family: 'Segoe UI', sans-serif;
    }
    /* Custom scrollbar for chat messages */
    #messages {
      scrollbar-width: thin;
      scrollbar-color: #4a5568 transparent;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: transparent;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #4a5568;
      border-radius: 4px;
    }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <!-- Container -->
  <div class="container mx-auto p-4">
    <!-- Authentication Section -->
    <div id="authSection" class="max-w-md mx-auto mb-6 p-4 bg-gray-800 rounded shadow-md">
      <h2 class="text-xl font-bold mb-4 text-center">Login / Signup</h2>
      <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600" />
      <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 rounded bg-gray-700 border border-gray-600" />
      <div class="flex justify-between">
        <button onclick="signup()" class="w-1/2 bg-purple-600 hover:bg-purple-700 p-2 rounded mr-2">Signup</button>
        <button onclick="login()" class="w-1/2 bg-blue-600 hover:bg-blue-700 p-2 rounded">Login</button>
      </div>
      <p id="authMessage" class="mt-3 text-center text-sm text-red-400"></p>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="hidden max-w-3xl mx-auto bg-gray-800 rounded shadow-md flex flex-col h-[80vh]">
      <div class="flex items-center justify-between border-b border-gray-700 p-4">
        <div class="flex items-center space-x-3">
          <img id="avatar" class="w-10 h-10 rounded-full border border-gray-600" src="" alt="Avatar" />
          <h2 id="welcomeMsg" class="text-xl font-bold"></h2>
        </div>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 p-2 rounded text-sm">Logout</button>
      </div>
      <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-3">
        <!-- Chat messages are appended here -->
      </div>
      <div class="border-t border-gray-700 p-4">
        <form id="chatForm" class="flex" onsubmit="sendMessage(event)">
          <input id="msgInput" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded-l bg-gray-700 border border-gray-600" required />
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 p-2 rounded-r">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Initialize GunDB with a public relay server:
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    // Create a Gun user instance:
    const gunUser = gun.user();

    // Global chat reference:
    const chat = gun.get("global-chat");

    // DOM elements
    const authSection = document.getElementById("authSection");
    const chatSection = document.getElementById("chatSection");
    const authMessage = document.getElementById("authMessage");
    const messagesEl = document.getElementById("messages");
    const welcomeMsg = document.getElementById("welcomeMsg");
    const avatarImg = document.getElementById("avatar");

    // Signup function: Create a new user
    function signup() {
      const alias = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;
      if (!alias || !pass) {
        authMessage.textContent = "Enter a username and password.";
        return;
      }
      gunUser.create(alias, pass, ack => {
        if (ack.err) {
          authMessage.textContent = "Signup Error: " + ack.err;
        } else {
          authMessage.textContent = "Signup successful! Please log in.";
        }
      });
    }

    // Login function: Authenticate an existing user
    function login() {
      const alias = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;
      if (!alias || !pass) {
        authMessage.textContent = "Enter your username and password.";
        return;
      }
      gunUser.auth(alias, pass, ack => {
        if (ack.err) {
          authMessage.textContent = "Login Error: " + ack.err;
        } else {
          // Save session info in sessionStorage for persistence
          sessionStorage.setItem("loggedIn", "true");
          sessionStorage.setItem("alias", alias);
          authMessage.textContent = "";
          showChat(alias);
        }
      });
    }

    // Logout: Ends user session
    function logout() {
      gunUser.leave();
      sessionStorage.clear();
      location.reload();
    }

    // Display the chat interface and subscribe to messages
    function showChat(alias) {
      authSection.style.display = "none";
      chatSection.classList.remove("hidden");
      welcomeMsg.textContent = "Hello, " + alias + "!";
      // Generate user avatar using DiceBear's API (via initials)
      avatarImg.src = "https://avatars.dicebear.com/api/initials/" + encodeURIComponent(alias) + ".svg";
      // Subscribe to new chat messages
      chat.map().on(renderMessage);
    }

    // Render chat messages in the chat window
    function renderMessage(data, key) {
      if (!data || !data.text) return;
      // Prevent duplicate messages
      let msgEl = document.getElementById(key);
      if (!msgEl) {
        msgEl = document.createElement("div");
        msgEl.id = key;
        msgEl.className = "p-2 rounded bg-gray-700";
        messagesEl.appendChild(msgEl);
      }
      const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : "";
      // Display avatar for the sender using DiceBear (if alias available)
      const senderAvatar = data.alias ? "<img class='inline-block w-6 h-6 rounded-full mr-2' src='https://avatars.dicebear.com/api/initials/" + encodeURIComponent(data.alias) + ".svg' alt='avatar' />" : "";
      msgEl.innerHTML = senderAvatar + "<span class='font-bold'>" + (data.alias || "Anonymous") + "</span> " +
                        "<span class='text-xs text-gray-400'>" + time + "</span><br>" +
                        data.text;
      // Auto-scroll to bottom
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Send message to the chat room
    function sendMessage(e) {
      e.preventDefault();
      const input = document.getElementById("msgInput");
      const text = input.value.trim();
      if (!text) return;
      const alias = sessionStorage.getItem("alias") || "Anonymous";
      // Publish message in GunDB
      chat.set({
        alias: alias,
        text: text,
        timestamp: new Date().getTime()
      });
      input.value = "";
    }

    // Auto-login if session exists
    window.onload = () => {
      if (sessionStorage.getItem("loggedIn")) {
        const alias = sessionStorage.getItem("alias");
        showChat(alias);
      }
    };
  </script>
</body>
</html>
