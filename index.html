<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Number Scanner</title>
<style>
  html, body {
    margin:0; padding:0;
    width:100%; height:100%;
    background: black;
    overflow: hidden;
    font-family: sans-serif;
  }
  video {
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    object-fit: cover;
    z-index: 1;
  }
  #scanBox {
    border: 3px solid red;
    position: absolute;
    top: 30%;
    left: 30%;
    width: 200px;
    height: 100px;
    z-index: 2;
    touch-action: none;
    background: rgba(255,0,0,0.1);
  }
  #controlsPanel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    padding: 10px;
    width: 200px;
    box-sizing: border-box;
    z-index: 3;
    display: none;
  }
  #toggleControls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 4;
    padding: 8px 15px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #e33;
    color: white;
    cursor: pointer;
    user-select: none;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #111;
  }
  input[type=number] {
    width: 100%;
    box-sizing: border-box;
    padding: 6px;
    font-size: 14px;
  }
  #startScan {
    margin-top: 10px;
    width: 100%;
    padding: 10px;
    font-size: 16px;
    background: #44a;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #startScan:disabled {
    background: #999;
    cursor: not-allowed;
  }
  .handle {
    width: 20px;
    height: 20px;
    background: red;
    position: absolute;
    z-index: 5;
    touch-action: none;
  }
  .top-left { left: -10px; top: -10px; cursor: nwse-resize; }
  .bottom-right { right: -10px; bottom: -10px; cursor: nwse-resize; }
</style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>

<div id="scanBox" tabindex="0" aria-label="Scan area">
  <div class="handle top-left"></div>
  <div class="handle bottom-right"></div>
</div>

<button id="toggleControls" aria-pressed="false" aria-controls="controlsPanel">Show Controls</button>

<div id="controlsPanel" role="region" aria-hidden="true">
  <label for="startRange">Start Number (inclusive):</label>
  <input type="number" id="startRange" placeholder="e.g. 100" />
  
  <label for="endRange">End Number (inclusive):</label>
  <input type="number" id="endRange" placeholder="e.g. 999" />
  
  <button id="startScan">Start Scanning</button>
  <button id="stopScan" disabled style="margin-top:8px; background:#a44;">Stop Scanning</button>
</div>

<audio id="alertSound" src="1.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<script>
(() => {
  const video = document.getElementById("video");
  const scanBox = document.getElementById("scanBox");
  const alertSound = document.getElementById("alertSound");
  const toggleControlsBtn = document.getElementById("toggleControls");
  const controlsPanel = document.getElementById("controlsPanel");
  const startScanBtn = document.getElementById("startScan");
  const stopScanBtn = document.getElementById("stopScan");
  const startInput = document.getElementById("startRange");
  const endInput = document.getElementById("endRange");

  let scanning = false;
  let rangeStart = 0, rangeEnd = 0;
  let scanInterval = null;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } },
        audio: false
      });
      video.srcObject = stream;
      await new Promise(resolve => {
        video.onloadedmetadata = () => resolve();
      });
      console.log("Camera started");
    } catch (e) {
      alert("Camera error: " + e.message);
    }
  }
  startCamera();

  // Toggle controls panel visibility
  toggleControlsBtn.addEventListener("click", () => {
    const visible = controlsPanel.style.display === "block";
    if (visible) {
      controlsPanel.style.display = "none";
      toggleControlsBtn.textContent = "Show Controls";
      toggleControlsBtn.setAttribute("aria-pressed", "false");
      controlsPanel.setAttribute("aria-hidden", "true");
    } else {
      controlsPanel.style.display = "block";
      toggleControlsBtn.textContent = "Hide Controls";
      toggleControlsBtn.setAttribute("aria-pressed", "true");
      controlsPanel.setAttribute("aria-hidden", "false");
    }
  });

  // Start scanning function
  startScanBtn.addEventListener("click", () => {
    if (scanning) return; // Already scanning
    rangeStart = parseInt(startInput.value);
    rangeEnd = parseInt(endInput.value);
    if (isNaN(rangeStart) || isNaN(rangeEnd)) {
      alert("Please enter valid start and end numbers.");
      return;
    }
    if (rangeStart > rangeEnd) {
      alert("Start number must be less than or equal to end number.");
      return;
    }
    scanning = true;
    startScanBtn.disabled = true;
    stopScanBtn.disabled = false;
    alertSound.pause();
    alertSound.currentTime = 0;
    console.log(`Scanning started for numbers between ${rangeStart} and ${rangeEnd}`);
    scanInterval = setInterval(scanOnce, 1000);
  });

  // Stop scanning function
  stopScanBtn.addEventListener("click", () => {
    if (!scanning) return;
    scanning = false;
    clearInterval(scanInterval);
    startScanBtn.disabled = false;
    stopScanBtn.disabled = true;
    alertSound.pause();
    alertSound.currentTime = 0;
    console.log("Scanning stopped");
  });

  // Scan once function
  async function scanOnce() {
    if (!scanning) return;

    const rect = scanBox.getBoundingClientRect();
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) {
      console.log("Video metadata not ready yet.");
      return;
    }

    const scaleX = vw / window.innerWidth;
    const scaleY = vh / window.innerHeight;

    const sx = rect.left * scaleX;
    const sy = rect.top * scaleY;
    const sw = rect.width * scaleX;
    const sh = rect.height * scaleY;

    if (sw <= 0 || sh <= 0) {
      console.log("Invalid scan box size");
      return;
    }

    canvas.width = sw;
    canvas.height = sh;

    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

    try {
      const { data: { text } } = await Tesseract.recognize(canvas, "eng", {
        tessedit_char_whitelist: "0123456789",
        // logger: m => console.log(m), // Uncomment to debug Tesseract progress
      });
      // Extract numbers and parse integers
      const matches = [...text.matchAll(/\d+/g)].map(m => parseInt(m[0], 10));
      if (matches.length) {
        console.log("Detected numbers:", matches);
        const found = matches.find(n => n >= rangeStart && n <= rangeEnd);
        if (found !== undefined) {
          scanning = false;
          clearInterval(scanInterval);
          startScanBtn.disabled = false;
          stopScanBtn.disabled = true;
          alertSound.loop = true;
          alertSound.play();
          alert(`Detected number: ${found}`);
          console.log(`Detected number: ${found}`);
        }
      }
    } catch (err) {
      console.error("OCR error:", err);
    }
  }

  // Dragging and resizing (touch and mouse support)
  (() => {
    let dragOffset = { x: 0, y: 0 };
    let isDragging = false;
    let resizing = false;
    let resizeHandle = null;
    let resizeStart = {};

    // Helpers
    function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }

    // Drag start
    scanBox.addEventListener("mousedown", dragStart);
    scanBox.addEventListener("touchstart", dragStart, { passive: false });

    function dragStart(e) {
      if (e.target.classList.contains("handle")) return;
      e.preventDefault();
      isDragging = true;
      const rect = scanBox.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      dragOffset.x = clientX - rect.left;
      dragOffset.y = clientY - rect.top;
      window.addEventListener("mousemove", dragging);
      window.addEventListener("mouseup", dragEnd);
      window.addEventListener("touchmove", dragging, { passive: false });
      window.addEventListener("touchend", dragEnd);
    }

    function dragging(e) {
      if (!isDragging) return;
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      let newLeft = clientX - dragOffset.x;
      let newTop = clientY - dragOffset.y;
      // Clamp inside viewport
      newLeft = clamp(newLeft, 0, window.innerWidth - scanBox.offsetWidth);
      newTop = clamp(newTop, 0, window.innerHeight - scanBox.offsetHeight);
      scanBox.style.left = `${newLeft}px`;
      scanBox.style.top = `${newTop}px`;
    }

    function dragEnd(e) {
      isDragging = false;
      window.removeEventListener("mousemove", dragging);
      window.removeEventListener("mouseup", dragEnd);
      window.removeEventListener("touchmove", dragging);
      window.removeEventListener("touchend", dragEnd);
    }

    // Resize start
    const topLeftHandle = scanBox.querySelector(".top-left");
    const bottomRightHandle = scanBox.querySelector(".bottom-right");

    topLeftHandle.addEventListener("mousedown", resizeStartFn);
    topLeftHandle.addEventListener("touchstart", resizeStartFn, { passive: false });
    bottomRightHandle.addEventListener("mousedown", resizeStartFn);
    bottomRightHandle.addEventListener("touchstart", resizeStartFn, { passive: false });

    function resizeStartFn(e) {
      e.preventDefault();
      resizing = true;
      resizeHandle = e.target;
      const rect = scanBox.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      resizeStart = {
        startX: clientX,
        startY: clientY,
        width: rect.width,
        height: rect.height,
        left: rect.left,
        top: rect.top
      };
      window.addEventListener("mousemove", resizingFn);
      window.addEventListener("mouseup", resizeEndFn);
      window.addEventListener("touchmove", resizingFn, { passive: false });
      window.addEventListener("touchend", resizeEndFn);
    }

    function resizingFn(e) {
      if (!resizing) return;
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const dx = clientX - resizeStart.startX;
      const dy = clientY - resizeStart.startY;

      if (resizeHandle === bottomRightHandle) {
        let newWidth = resizeStart.width + dx;
        let newHeight = resizeStart.height + dy;
        newWidth = clamp(newWidth, 50, window.innerWidth - resizeStart.left);
        newHeight = clamp(newHeight, 30, window.innerHeight - resizeStart.top);
        scanBox.style.width = newWidth + "px";
        scanBox.style.height = newHeight + "px";
      } else if (resizeHandle === topLeftHandle) {
        let newLeft = resizeStart.left + dx;
        let newTop = resizeStart.top + dy;
        let newWidth = resizeStart.width - dx;
        let newHeight = resizeStart.height - dy;

        // Clamp values to viewport and minimum size
        if (newWidth < 50) {
          newWidth = 50;
          newLeft = resizeStart.left + (resizeStart.width - 50);
        }
        if (newHeight < 30) {
          newHeight = 30;
          newTop = resizeStart.top + (resizeStart.height - 30);
        }
        newLeft = clamp(newLeft, 0, resizeStart.left + resizeStart.width - 50);
        newTop = clamp(newTop, 0, resizeStart.top + resizeStart.height - 30);

        scanBox.style.left = newLeft + "px";
        scanBox.style.top = newTop + "px";
        scanBox.style.width = newWidth + "px";
        scanBox.style.height = newHeight + "px";
      }
    }

    function resizeEndFn(e) {
      resizing = false;
      resizeHandle = null;
      window.removeEventListener("mousemove", resizingFn);
      window.removeEventListener("mouseup", resizeEndFn);
      window.removeEventListener("touchmove", resizingFn);
      window.removeEventListener("touchend", resizeEndFn);
    }
  })();
})();
</script>

</body>
</html>
